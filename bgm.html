<style>
  .mp-wrap{
    position: fixed; right:16px;
    bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
    z-index: 9999;
    display:flex; flex-direction:column; align-items:flex-end; gap:8px;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }
  .mp-head{
    display:flex; align-items:center; gap:8px;
    background:#fff; border:1px solid var(--border,#e9dfd7);
    box-shadow:0 6px 18px rgba(0,0,0,.12);
    color:var(--text,#433);
    border-radius:999px; padding:8px 12px; cursor:pointer; user-select:none;
  }
  .mp-head .label{ font-size:.9rem; color:var(--muted,#7a6f6a); }
  .mp-panel{
    background:#fff; border:1px solid var(--border,#e9dfd7); box-shadow:0 6px 18px rgba(0,0,0,.12);
    border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:8px; width:360px; max-width:92vw;
    transform-origin: bottom right; transition: transform .18s ease, opacity .18s ease;
  }
  .mp-wrap:not(.is-open) .mp-panel{ transform: scale(.92); opacity:0; pointer-events:none; }
  .mp-row{ display:flex; align-items:center; gap:8px; }
  .mp-title{
    font-size:.92rem; color:var(--muted,#7a6f6a);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;
  }
  .mp-btn{
    border:1px solid var(--border,#e9dfd7); background:#fff; color:inherit;
    border-radius:10px; padding:6px 10px; cursor:pointer; font-size:14px;
  }
  .mp-range{ accent-color:#c58; height:4px; flex:1; }
  .mp-time{ font-size:.8rem; color:var(--muted,#7a6f6a); min-width:74px; text-align:right; }
  .mp-sel{
    border:1px solid var(--border,#e9dfd7); border-radius:10px;
    padding:6px 8px; background:#fff; font-size:.9rem; color:var(--text,#433);
  }
  @media (max-width:520px){
    .mp-wrap{ right:12px; bottom: calc(env(safe-area-inset-bottom, 0px) + 20px); }
  }
</style>

<!-- å¤ç”¨/åˆ›å»ºéŸ³é¢‘å…ƒç´ ï¼šä¸å±•ç¤ºéŸ³é‡ï¼Œä»…ä¿ç•™é™éŸ³ -->
<audio id="bgm" preload="auto" autoplay muted playsinline style="display:none;">
  <source src="ç¥ä½ ç”Ÿæ—¥å¿«ä¹.mp3" type="audio/mpeg">
</audio>

<div class="mp-wrap" id="mpWrap" aria-live="polite">
  <button class="mp-head" id="mpToggle" aria-expanded="false" aria-controls="mpPanel">
    <span>ğŸµ</span><span class="label">æ’­æ”¾å™¨</span>
  </button>

  <div class="mp-panel" id="mpPanel" role="group" aria-label="èƒŒæ™¯éŸ³ä¹æ§åˆ¶">
    <div class="mp-row">
      <button class="mp-btn" id="mpPrev">â®ï¸</button>
      <button class="mp-btn" id="mpPlay">â–¶ï¸</button>
      <button class="mp-btn" id="mpNext">â­ï¸</button>
      <button class="mp-btn" id="mpMute">ğŸ”‡</button>
      <div class="mp-title" id="mpTitle">èƒŒæ™¯éŸ³ä¹</div>
    </div>
    <div class="mp-row">
      <select id="mpSel" class="mp-sel" title="é€‰æ‹©æ›²ç›®"></select>
      <input id="mpSeek" class="mp-range" type="range" min="0" max="100" value="0">
      <span class="mp-time" id="mpTime">00:00 / 00:00</span>
    </div>
    <!-- å·²åˆ é™¤éŸ³é‡è¡Œ -->
  </div>
</div>

<script>
(function(){
  const wrap  = document.getElementById('mpWrap');
  const toggle= document.getElementById('mpToggle');

  // æŠ˜å è®°å¿†
  const K=(k)=>`bgm.${k}`;
  const savedOpen = localStorage.getItem(K('open'));
  const open = savedOpen===null?false:(savedOpen==='true');
  wrap.classList.toggle('is-open', open);
  toggle.setAttribute('aria-expanded', String(open));
  toggle.onclick = ()=>{
    const now = !wrap.classList.contains('is-open');
    wrap.classList.toggle('is-open', now);
    toggle.setAttribute('aria-expanded', String(now));
    try{ localStorage.setItem(K('open'), String(now)); }catch(e){}
  };

  // éŸ³é¢‘ & æ§ä»¶
  const a     = document.getElementById('bgm') || document.querySelector('audio');
  const bPrev = document.getElementById('mpPrev');
  const bPlay = document.getElementById('mpPlay');
  const bNext = document.getElementById('mpNext');
  const bMute = document.getElementById('mpMute');
  const t     = document.getElementById('mpTitle');
  const sel   = document.getElementById('mpSel');
  const seek  = document.getElementById('mpSeek');
  const time  = document.getElementById('mpTime');
  if(!a){ console.warn('æœªæ‰¾åˆ° <audio id="bgm">'); return; }
  a.loop = false;

  // æ›²ç›®
  const tracks = [
    { src: 'ç¥ä½ ç”Ÿæ—¥å¿«ä¹.mp3',     title: 'ç¥ä½ ç”Ÿæ—¥å¿«ä¹.mp3' },
    { src: 'åƒåƒé—‹æ­Œ.mp3',           title: 'åƒåƒé—‹æ­Œ.mp3' },
    { src: 'Whispers_of_the Forest.mp3',   title: 'Whispers_of_the Forest.mp3' }
  ];
  sel.innerHTML = tracks.map((tr,i)=>`<option value="${i}">${tr.title}</option>`).join('');

  const KIDX = K('index');
  let idx = Math.min(tracks.length-1, Math.max(0, parseInt(localStorage.getItem(KIDX) || '0', 10)));
  const savedMuted = localStorage.getItem(K('muted'));
  if (savedMuted !== null) a.muted = (savedMuted === 'true');

  const fmt = (s)=>{ s=Math.max(0, Math.floor(s)); const m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; };
  function syncButtons(){ bPlay.textContent = a.paused ? 'â–¶ï¸' : 'â¸ï¸'; bMute.textContent = a.muted ? 'ğŸ”‡' : 'ğŸ”Š'; }
  function syncTime(){ const cur=a.currentTime||0, dur=isFinite(a.duration)?a.duration:0;
    time.textContent = `${fmt(cur)} / ${fmt(dur)}`; if(dur>0) seek.value = Math.round(cur/dur*100); }
  function saveState(){
    try{
      localStorage.setItem(K('muted'), String(!!a.muted));
      localStorage.setItem(KIDX, String(idx));
      localStorage.setItem(K(`time.${idx}`), String(a.currentTime||0));
    }catch(e){}
  }
  function setTitle(name){
    try{
      t.textContent = name || decodeURIComponent(new URL(a.currentSrc||a.src, location.href).pathname.split('/').pop());
    }catch(e){ t.textContent = name || 'èƒŒæ™¯éŸ³ä¹'; }
  }
  function loadTrack(i, {resume=true, autoplay=true} = {}){
    idx = ( (i % tracks.length) + tracks.length ) % tracks.length; // ç¯ç»•
    const tr = tracks[idx];
    a.src = tr.src;
    setTitle(tr.title);
    sel.value = String(idx);

    const saved = parseFloat(localStorage.getItem(K(`time.${idx}`)) || '0');
    const setTime = ()=> {
      if(!isNaN(saved) && saved>0 && isFinite(a.duration) && saved < a.duration){
        a.currentTime = resume ? saved : 0;
      }
      syncTime();
    };
    if (a.readyState >= 1) setTime(); else a.addEventListener('loadedmetadata', setTime, {once:true});

    if (autoplay){
      a.play().then(()=>{
        a.muted = false; syncButtons();
        // 0.8s æ·¡å…¥ï¼Œä»…å†…éƒ¨æ§åˆ¶ï¼Œä¸æä¾› UI
        const target = 1.0; // å›ºå®šä¸ºæ»¡éŸ³é‡
        const v0 = 0;
        a.volume = v0;
        const t0 = performance.now(), dur = 800;
        (function fadeIn(now){
          const p = Math.min(1, (now - t0) / dur);
          a.volume = v0 + (target - v0) * p;
          if (p < 1) requestAnimationFrame(fadeIn);
        })(t0);
      }).catch(()=>{
        // è‹¥è¢«æµè§ˆå™¨ç­–ç•¥é˜»æ­¢è‡ªåŠ¨æ’­æ”¾ï¼Œä¿æŒé™éŸ³ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡» â–¶ï¸
        a.muted = true; syncButtons();
      });
    } else { syncButtons(); }

    localStorage.setItem(KIDX, String(idx));
  }

  // é¦–æ¬¡è£…è½½
  loadTrack(idx, {resume:true, autoplay:true});

  // äº‹ä»¶
  bPlay.onclick = async ()=>{
    if (a.paused) {
      try{ await a.play(); }catch(e){}
      a.muted=false;
      a.volume=1; // ä¿æŒæ»¡éŸ³é‡
    } else {
      a.pause();
    }
    syncButtons(); saveState();
  };
  bMute.onclick = ()=>{ a.muted=!a.muted; syncButtons(); saveState(); };
  bPrev.onclick = ()=> loadTrack(idx-1, {resume:true, autoplay:true});
  bNext.onclick = ()=> loadTrack(idx+1, {resume:true, autoplay:true});
  sel.onchange   = ()=> loadTrack(parseInt(sel.value,10)||0, {resume:true, autoplay:true});
  seek.oninput   = ()=>{ const d=isFinite(a.duration)?a.duration:0; if(d>0) a.currentTime=(seek.value/100)*d; syncTime(); saveState(); };

  a.addEventListener('ended', ()=> loadTrack(idx+1, {resume:false, autoplay:true}));
  ['play','pause','timeupdate','volumechange','loadeddata','canplay'].forEach(ev=>{
    a.addEventListener(ev, ()=>{ syncButtons(); syncTime(); saveState(); });
  });
  document.addEventListener('visibilitychange', saveState);
  window.addEventListener('pagehide', saveState);
})();
</script>